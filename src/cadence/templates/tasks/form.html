{% extends "base.html" %}

{% block title %}{{ 'Edit Task' if task else 'New Task' }} - Cadence{% endblock %}

{% if task and g.user.is_admin and all_users %}
{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='vendor/tom-select.min.css') }}">
{% endblock %}
{% endif %}

{% block content %}
<article>
    <header>
        <h1>{{ 'Edit Task' if task else 'New Task' }}</h1>
    </header>

    <form method="POST">
        <label for="title">
            Title
            <input type="text" id="title" name="title" value="{{ title or '' }}" required autofocus>
        </label>

        <label for="description">
            Description
            <textarea id="description" name="description" rows="5">{{ description or '' }}</textarea>
        </label>

        <label for="due_date">
            Due Date <small>(optional)</small>
            <input type="date" id="due_date" name="due_date" value="{{ due_date or '' }}">
        </label>

        {% if task and g.user.is_admin and all_users %}
        <label for="owner_id">
            Owner
            <select id="owner_id" name="owner_id" placeholder="Search users..."></select>
        </label>
        <script type="application/json" id="owner-data">
        {
            "currentOwnerId": {{ task.owner_id }},
            "users": [
                {% for user in all_users %}{% if not loop.first %},{% endif %}
                {"id": {{ user.id }}, "text": "{{ (user.display_name or user.email)|e }}", "email": "{{ user.email|e }}"}
                {% endfor %}
            ]
        }
        </script>
        {% endif %}

        <label>
            <input type="checkbox" id="is_private" name="is_private" value="1" {{ 'checked' if is_private else '' }}>
            Private (only visible to you)
        </label>

        {% if task %}
        <label>
            <input type="checkbox" id="skip_notification" name="skip_notification" value="1">
            Skip notification (don't notify watchers of this change)
        </label>
        {% endif %}

        <footer class="form-actions">
            <button type="button" class="outline secondary" onclick="location.href='{{ url_for('tasks.view', task_uuid=task.uuid) if task else url_for('tasks.index') }}'">Cancel</button>
            <button type="submit">{{ 'Save Changes' if task else 'Create Task' }}</button>
        </footer>
    </form>
</article>
{% endblock %}

{% if task and g.user.is_admin and all_users %}
{% block scripts %}
<script src="{{ url_for('static', filename='vendor/tom-select.min.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    var dataEl = document.getElementById('owner-data');
    if (!dataEl) return;

    var config;
    try {
        config = JSON.parse(dataEl.textContent);
    } catch (e) {
        console.error('Failed to parse owner data:', e);
        return;
    }

    var selectEl = document.getElementById('owner_id');
    if (!selectEl) return;

    new TomSelect(selectEl, {
        valueField: 'id',
        labelField: 'text',
        searchField: ['text', 'email'],
        maxItems: 1,
        options: config.users,
        items: [config.currentOwnerId],
        render: {
            option: function(data, escape) {
                return '<div class="ts-option-item">' +
                    '<span class="user-name">' + escape(data.text) + '</span>' +
                    (data.email && data.email !== data.text ? '<small class="user-email"> (' + escape(data.email) + ')</small>' : '') +
                '</div>';
            },
            item: function(data, escape) {
                return '<div>' + escape(data.text) + '</div>';
            }
        }
    });
});
</script>
{% endblock %}
{% endif %}
