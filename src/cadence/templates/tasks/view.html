{% extends "base.html" %}

{% block title %}{{ task.title }} - Cadence{% endblock %}

{% block content %}
<article>
    <header>
        <hgroup>
            <h1>{{ task.title }}</h1>
            <p>
                Created by {{ owner.display_name or owner.email if owner else 'Unknown' }}
                on {{ task.created_at|localdate }}
                {% if task.is_private %}<small>(private)</small>{% endif %}
            </p>
        </hgroup>
    </header>

    <nav class="task-toolbar">
        {% if task.owner_id == g.user.id or g.user.is_admin %}
        <button type="button" class="outline" onclick="location.href='{{ url_for('tasks.edit', task_uuid=task.uuid) }}'">Edit</button>
        {% endif %}
        {% if (task.owner_id == g.user.id or g.user.is_admin) and allowed_transitions %}
        <button type="button" class="outline" onclick="document.getElementById('status-dialog').showModal()">Status</button>
        {% endif %}
        <button type="button" class="outline" onclick="openCommentDialog()">Comment</button>
        <button type="button" class="outline" onclick="document.getElementById('upload-dialog').showModal()">Upload</button>
        <span id="watch-button">{% include "tasks/_watch_button.html" %}</span>
        {% if task.owner_id == g.user.id or g.user.is_admin %}
        <button type="button" class="outline contrast" onclick="document.getElementById('delete-dialog').showModal()">Delete...</button>
        {% endif %}
    </nav>

    <div id="task-status">
        {% include "tasks/_status.html" %}
    </div>

    <div id="watchers-section">
        {% include "tasks/_watchers.html" %}
    </div>

    {% if task.due_date %}
    <p><strong>Due:</strong> {{ task.due_date|localdate }}</p>
    {% endif %}

    {% if task.description %}
    <div class="task-description">
        <h3>Description</h3>
        <div class="markdown-content">{{ task.description|markdown_block }}</div>
    </div>
    {% endif %}

    <footer>
        <a href="{{ url_for('tasks.index') }}">&larr; Back to tasks</a>
    </footer>
</article>

<article>
    <header>
        <h3>Timeline</h3>
    </header>
    <div id="activity-section">
        {% include "tasks/_activity.html" %}
    </div>
</article>

<!-- Status Dialog -->
{% if (task.owner_id == g.user.id or g.user.is_admin) and allowed_transitions %}
<dialog id="status-dialog">
    <article>
        <header>
            <button type="button" aria-label="Close" rel="prev" onclick="document.getElementById('status-dialog').close()"></button>
            <h3>Change Status</h3>
        </header>
        <form method="POST"
              action="{{ url_for('tasks.change_status', task_uuid=task.uuid) }}"
              hx-post="{{ url_for('tasks.change_status', task_uuid=task.uuid) }}"
              hx-target="#task-status"
              hx-swap="innerHTML"
              hx-on::after-request="if(event.detail.successful) document.getElementById('status-dialog').close()">
            <label for="dialog-status">
                New Status
                <select id="dialog-status" name="status" required autofocus>
                    <option value="">Select status...</option>
                    {% for status in allowed_transitions %}
                    <option value="{{ status }}">{{ status|replace('_', ' ')|title }}</option>
                    {% endfor %}
                </select>
            </label>
            <footer class="form-actions">
                <button type="submit">Update Status</button>
                <button type="button" class="outline" onclick="document.getElementById('status-dialog').close()">Cancel</button>
            </footer>
        </form>
    </article>
</dialog>
{% endif %}

<!-- Comment Dialog -->
<dialog id="comment-dialog">
    <article>
        <header>
            <button type="button" aria-label="Close" rel="prev" onclick="closeCommentDialog()"></button>
            <h3 id="comment-dialog-title">Add Comment</h3>
        </header>
        <form id="comment-form" method="POST"
              action="{{ url_for('tasks.add_comment', task_uuid=task.uuid) }}"
              hx-post="{{ url_for('tasks.add_comment', task_uuid=task.uuid) }}"
              hx-target="#activity-section"
              hx-swap="innerHTML"
              hx-on::after-request="if(event.detail.successful) { this.reset(); closeCommentDialog(); }">
            <label for="dialog-content">
                Comment
                <textarea id="dialog-content" name="content" rows="4" required autofocus></textarea>
            </label>
            <details class="markdown-help">
                <summary>Formatting help</summary>
                <ul>
                    <li><code># Heading</code> → heading (## for smaller)</li>
                    <li><code>**bold**</code> → <strong>bold</strong></li>
                    <li><code>*italic*</code> → <em>italic</em></li>
                    <li><code>~~strike~~</code> → <del>strike</del></li>
                    <li><code>`code`</code> → <code>code</code></li>
                    <li><code>[link](url)</code> → link</li>
                    <li><code>- item</code> → bullet list</li>
                    <li><code>1. item</code> → numbered list</li>
                    <li><code>> quote</code> → blockquote</li>
                </ul>
            </details>
            <footer class="form-actions">
                <button type="submit" id="comment-submit-btn">Post Comment</button>
                <button type="button" class="outline" onclick="closeCommentDialog()">Cancel</button>
            </footer>
        </form>
    </article>
</dialog>

<script>
var editButtonTimestamps = {};

function openCommentDialog(editUrl, content, expiresInSeconds) {
    var dialog = document.getElementById('comment-dialog');
    var form = document.getElementById('comment-form');
    var textarea = document.getElementById('dialog-content');
    var title = document.getElementById('comment-dialog-title');
    var btn = document.getElementById('comment-submit-btn');

    if (editUrl) {
        // Check if edit window has expired (client-side check)
        var btnKey = editUrl;
        if (editButtonTimestamps[btnKey]) {
            var elapsed = (Date.now() - editButtonTimestamps[btnKey]) / 1000;
            var originalExpiry = expiresInSeconds + elapsed;
            if (elapsed >= expiresInSeconds) {
                alert('The edit window has expired. You can no longer edit this comment.');
                return;
            }
        } else {
            // Store when we first saw this button with its expiry
            editButtonTimestamps[btnKey] = Date.now() - (({{ edit_window_seconds }} - expiresInSeconds) * 1000);
        }

        form.setAttribute('action', editUrl);
        form.setAttribute('hx-post', editUrl);
        htmx.process(form);
        textarea.value = content || '';
        title.textContent = 'Edit Comment';
        btn.textContent = 'Save';
    } else {
        form.setAttribute('action', '{{ url_for('tasks.add_comment', task_uuid=task.uuid) }}');
        form.setAttribute('hx-post', '{{ url_for('tasks.add_comment', task_uuid=task.uuid) }}');
        htmx.process(form);
        textarea.value = '';
        title.textContent = 'Add Comment';
        btn.textContent = 'Post Comment';
    }
    dialog.showModal();
}

function closeCommentDialog() {
    var dialog = document.getElementById('comment-dialog');
    var form = document.getElementById('comment-form');
    form.reset();
    form.setAttribute('action', '{{ url_for('tasks.add_comment', task_uuid=task.uuid) }}');
    form.setAttribute('hx-post', '{{ url_for('tasks.add_comment', task_uuid=task.uuid) }}');
    htmx.process(form);
    document.getElementById('comment-dialog-title').textContent = 'Add Comment';
    document.getElementById('comment-submit-btn').textContent = 'Post Comment';
    dialog.close();
}
</script>

<!-- Upload Dialog -->
<dialog id="upload-dialog">
    <article>
        <header>
            <button type="button" aria-label="Close" rel="prev" onclick="document.getElementById('upload-dialog').close()"></button>
            <h3>Upload File</h3>
        </header>
        <form id="upload-form" method="POST"
              action="{{ url_for('tasks.upload_attachment', task_uuid=task.uuid) }}"
              hx-post="{{ url_for('tasks.upload_attachment', task_uuid=task.uuid) }}"
              hx-target="#activity-section"
              hx-swap="innerHTML"
              hx-encoding="multipart/form-data"
              hx-on::after-request="if(event.detail.successful) { this.reset(); document.getElementById('upload-dialog').close(); }">
            <label for="dialog-file">
                File
                <input type="file" id="dialog-file" name="file" required>
            </label>
            <footer class="form-actions">
                <button type="submit">Upload</button>
                <button type="button" class="outline" onclick="document.getElementById('upload-dialog').close()">Cancel</button>
            </footer>
        </form>
    </article>
</dialog>

<!-- Delete Dialog -->
{% if task.owner_id == g.user.id or g.user.is_admin %}
<dialog id="delete-dialog">
    <article>
        <header>
            <button type="button" aria-label="Close" rel="prev" onclick="document.getElementById('delete-dialog').close()"></button>
            <h3>Delete Task</h3>
        </header>
        <p>Are you sure you want to delete this task? This action cannot be undone.</p>
        <form method="POST" action="{{ url_for('tasks.delete', task_uuid=task.uuid) }}">
            <footer class="form-actions">
                <button type="submit" class="contrast">Delete Task</button>
                <button type="button" class="outline" onclick="document.getElementById('delete-dialog').close()">Cancel</button>
            </footer>
        </form>
    </article>
</dialog>
{% endif %}
{% endblock %}
