<p><strong>Watchers:</strong></p>

{% if can_manage_watchers %}
<div class="watchers-control">
    <select id="watchers-select" name="usernames" multiple placeholder="Type to add..."></select>
</div>
<script type="application/json" id="watchers-data">
{
    "watchers": [
        {% set owner_watcher = watchers|selectattr('username', 'eq', task.owner)|first %}
        {% if owner_watcher %}{"id": "{{ owner_watcher.username|e }}", "text": "{{ owner_watcher.display_name|e }}"}{% endif %}
        {% for w in watchers if w.username != task.owner %}{% if owner_watcher or not loop.first %},{% endif %}
        {"id": "{{ w.username|e }}", "text": "{{ w.display_name|e }}"}{% endfor %}
    ],
    "addUrl": "{{ url_for('tasks.add_watcher', task_uuid=task.uuid) }}",
    "removeUrlBase": "{{ url_for('tasks.remove_watcher', task_uuid=task.uuid, username='__USERNAME__')|replace('__USERNAME__', '{id}') }}",
    "searchUrl": "{{ url_for('tasks.search_users', task_uuid=task.uuid) }}",
    "ownerId": "{{ task.owner }}"
}
</script>
{% else %}
{% if watchers %}
<ul class="watcher-list compact">
    {% for w in watchers %}
    <li>
        {{ w.display_name }}
        {% if w.username == task.owner %}<small>(owner)</small>{% endif %}
    </li>
    {% endfor %}
</ul>
{% else %}
<p class="muted">No watchers yet.</p>
{% endif %}
{% endif %}
