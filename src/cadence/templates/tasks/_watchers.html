<p><strong>Watchers:</strong></p>

{% if can_manage_watchers %}
<div class="watchers-control">
    <select id="watchers-select" name="user_ids" multiple placeholder="Type to add..."></select>
</div>
<script type="application/json" id="watchers-data">
{
    "watchers": [
        {% set owner_watcher = watchers|selectattr('id', 'eq', task.owner_id)|first %}
        {% if owner_watcher %}{"id": {{ owner_watcher.id }}, "text": "{{ (owner_watcher.display_name or owner_watcher.email)|e }}"}{% endif %}
        {% for w in watchers if w.id != task.owner_id %}{% if owner_watcher or not loop.first %},{% endif %}
        {"id": {{ w.id }}, "text": "{{ (w.display_name or w.email)|e }}"}{% endfor %}
    ],
    "addUrl": "{{ url_for('tasks.add_watcher', task_uuid=task.uuid) }}",
    "removeUrlBase": "{{ url_for('tasks.remove_watcher', task_uuid=task.uuid, user_id=0)|replace('/0/', '/{id}/') }}",
    "searchUrl": "{{ url_for('tasks.search_users', task_uuid=task.uuid) }}",
    "ownerId": {{ task.owner_id }}
}
</script>
{% else %}
{% if watchers %}
<ul class="watcher-list compact">
    {% for w in watchers %}
    <li>
        {{ w.display_name or w.email }}
        {% if w.id == task.owner_id %}<small>(owner)</small>{% endif %}
    </li>
    {% endfor %}
</ul>
{% else %}
<p class="muted">No watchers yet.</p>
{% endif %}
{% endif %}
