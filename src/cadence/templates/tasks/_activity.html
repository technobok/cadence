{% if activities %}
<ul class="activity-list">
    {% for activity in activities %}
    <li class="activity-item {% if activity.action == 'commented' %}activity-comment{% elif activity.action == 'attachment_added' %}activity-attachment{% endif %}">
        <div class="activity-header">
            <strong>{{ users[activity.user_id].display_name or users[activity.user_id].email if activity.user_id in users else 'System' }}</strong>
            <span class="activity-action-text">{{ activity.action|replace('_', ' ') }}</span>
            <small class="activity-time">{{ activity.logged_at|localdatetime }}</small>
        </div>

        {% if activity.action == 'commented' and activity.details and activity.details.content %}
        {% set comment = comments_by_uuid.get(activity.details.comment_uuid) if activity.details.comment_uuid else none %}
        {% set can_edit_as_author = comment and comment.user_id == g.user.id and comment.is_editable(edit_window_seconds) %}
        {% set can_edit = g.user.is_admin or can_edit_as_author %}
        {% set edit_expires_in = comment.seconds_until_edit_expires(edit_window_seconds) if can_edit_as_author else 9999 %}
        <div class="activity-content">
            <div class="comment-content markdown-content">{{ activity.details.content|markdown_block }}</div>
            <div class="comment-actions">
                {% if can_edit and activity.details.comment_uuid %}
                <button type="button" class="outline secondary activity-edit"
                        data-edit-url="{{ url_for('tasks.edit_comment', task_uuid=task.uuid, comment_uuid=activity.details.comment_uuid) }}"
                        data-content="{{ activity.details.content|e }}"
                        data-expires="{{ edit_expires_in }}"
                        onclick="openCommentDialog(this.dataset.editUrl, this.dataset.content, parseInt(this.dataset.expires))">Edit</button>
                {% endif %}
                {% if activity.details.comment_uuid and g.user.is_admin %}
                <form method="POST"
                      action="{{ url_for('tasks.delete_comment', task_uuid=task.uuid, comment_uuid=activity.details.comment_uuid) }}"
                      hx-post="{{ url_for('tasks.delete_comment', task_uuid=task.uuid, comment_uuid=activity.details.comment_uuid) }}"
                      hx-target="#activity-section"
                      hx-swap="innerHTML"
                      class="activity-delete-form">
                    <button type="submit" class="outline secondary activity-delete" onclick="return confirm('Delete this comment?')">Delete</button>
                </form>
                {% endif %}
            </div>
        </div>

        {% elif activity.action == 'attachment_added' and activity.details %}
        <div class="activity-content">
            {% if activity.details.attachment_uuid %}
            <a href="{{ url_for('tasks.download_attachment', task_uuid=task.uuid, attachment_uuid=activity.details.attachment_uuid) }}" class="attachment-link">
                {{ activity.details.filename }}
            </a>
            {% if activity.details.file_size %}
            <small class="attachment-meta">({{ format_file_size(activity.details.file_size) }})</small>
            {% endif %}
            {% if g.user.is_admin %}
            <form method="POST"
                  action="{{ url_for('tasks.delete_attachment', task_uuid=task.uuid, attachment_uuid=activity.details.attachment_uuid) }}"
                  hx-post="{{ url_for('tasks.delete_attachment', task_uuid=task.uuid, attachment_uuid=activity.details.attachment_uuid) }}"
                  hx-target="#activity-section"
                  hx-swap="innerHTML"
                  class="activity-delete-form">
                <button type="submit" class="outline secondary activity-delete" onclick="return confirm('Delete this attachment?')">Delete</button>
            </form>
            {% endif %}
            {% else %}
            {{ activity.details.filename }}
            {% endif %}
        </div>

        {% elif activity.action == 'attachment_deleted' and activity.details %}
        <div class="activity-details">
            <small>{{ activity.details.filename }}</small>
        </div>

        {% elif activity.action == 'status_changed' and activity.details %}
        <div class="activity-details">
            {{ activity.details.old }} &rarr; {{ activity.details.new }}
        </div>

        {% elif activity.action == 'updated' and activity.details and activity.details.changes %}
        <div class="activity-details">
            {% for change in activity.details.changes %}
            <small>{{ change.field }}: {{ change.old[:50] if change.old else '(empty)' }} &rarr; {{ change.new[:50] }}</small>
            {% endfor %}
        </div>
        {% endif %}
    </li>
    {% endfor %}
</ul>
{% else %}
<p class="no-activity">No activity yet.</p>
{% endif %}
