# Cadence - Docker Compose configuration
# Usage: docker compose up -d

services:
  init:
    build: .
    container_name: cadence-init
    command: >
      sh -c "
        if [ ! -f /app/instance/cadence.sqlite3 ]; then
          echo 'Initializing database...'
          flask --app wsgi init-db
        else
          echo 'Database already exists, skipping init'
        fi
      "
    volumes:
      - ./instance:/app/instance
    restart: "no"
    profiles:
      - init

  app:
    build: .
    container_name: cadence-app
    volumes:
      - ./instance:/app/instance
      - ${GATEKEEPER_DB_PATH:-../gatekeeper/instance/gatekeeper.sqlite3}:/data/gatekeeper.sqlite3:ro
    environment:
      - PYTHONUNBUFFERED=1
      - TZ=${TZ:-UTC}
      - GATEKEEPER_DB=/data/gatekeeper.sqlite3
    networks:
      - platform-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:5000/')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  worker:
    build: .
    container_name: cadence-worker
    command: ["python", "-m", "worker.notification_worker"]
    volumes:
      - ./instance:/app/instance
      - ${GATEKEEPER_DB_PATH:-../gatekeeper/instance/gatekeeper.sqlite3}:/data/gatekeeper.sqlite3:ro
    environment:
      - PYTHONUNBUFFERED=1
      - TZ=${TZ:-UTC}
      - GATEKEEPER_DB=/data/gatekeeper.sqlite3
    networks:
      - platform-net
    restart: unless-stopped

networks:
  platform-net:
    external: true
